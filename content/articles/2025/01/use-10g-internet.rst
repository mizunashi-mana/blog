10G光インターネットを使う
==========================

:tags: 光回線, インターネット, IPoE, ルータ, ネットワーク
:category: サービス

最近ネット回線を特に意味もなく10Gプランに変えてみたので、その備忘録。特にいくつか詰まる部分があったので、それを残しておく。

10GbE市販普及の背景
-------------------------

さて、インターネットが人類に欠かせない社会インフラとなってから、30年ぐらい経とうとしている。最近は、インターネットが関与しないサービス、全く利用しない人というのはほぼいないだろう。そのため、技術もそれに合わせて進歩してきている。例えば、インターネットの基盤だったIPプロトコルも、v4からv6への移行が着実に進みつつあり、Google先生が公開している `IPv6使用状況データ <https://www.google.com/intl/ja/ipv6/statistics.html>`_ によると、45%のトラフィックがIPv6で行われるようになってきているようだ。また、ダイヤルアップ接続からADSL、光回線と物理的な配線状況も変わってきており、それに合わせて PPPoE ではなく IPoE での接続を提供するプロバイダも増えてきている。今や当たり前となった無線LANの技術も変わってきており、高密度環境を想定し、WPA3によるセキュリティ強化などを行なったWi-Fi 6 (IEEE 802.11ax)、Wi-Fi 7 (IEEE 802.11be) などの規格も登場している。イーサネットもトラフィックの爆増を見据えて、ギガビットイーサ (GbE) からテラビットイーサ (TbE) への領域に足を踏み出し始めていて、25Gイーサネットコンソーシアムが、800GbEの発表と共にイーサネットテクノロジーコンソーシアムに改名したのが進化の流れの速さを物語っているだろう。

このような状況で、今までデータセンターなど特別なトラフィック需要を持つ場所でしか使われてこなかった10ギガビットイーサネット、通称10GbEも、市販に降りてくるようになってきている。これは、もちろん光ネットワーク (PON) が、10G-EPON などのイーサネット基盤の登場と、家庭配線が10GBaseへ対応してきたことなどのインフラの一新が進んできたことも大きいが、ルータやWi-Fi規格などの市販ネットワーク機器が10GBaseの恩恵を受けられるようになってきたというのも大きいだろう。2025年現在、正直10GBaseはまだ若干早すぎる感は否めず、大体はどこかで1GBase止まりになる気はするが、それでも最新の機種は明確に10GbEを意識するようになってるんじゃないだろうか。

さて、僕は特に何も考えず惰性でビッグローブ光を使い続けてるんだが、ビッグローブ光が10Gプランを最近公開したので、そんなこんなでちょっと試してみるかということで1Gプランからの回線変更してみることにした。ついでにビッグローブ光はおそらく裏側はNTT フレッツ光で、10Gの場合はフレッツ光クロスをバックエンドに使ってると思われる [#biglobe-and-ntt-flets]_。ビッグローブ光がいいサービスかはノーコメントで。最終的にいくつかトラブルを踏んだが、まあ1日ネット使えなくなっただけで無事移行できた。ネット環境は確かにそれなりに快適にはなったが、そこに到達するには色々やる羽目にはなるのでそこら辺を書いておく。

10GbEに必要なもの
------------------------

まず一つ言っておくことがある。それは、基本的に10Gプランというのは物好きが使うプランであるということ、そして10Gプランの恩恵を受ける場合はそれなりの投資が必要になるということだ。日本のインターネット回線業者というのは基本タチが悪いと僕は勝手に思ってるんだが、家庭用10GbEプランの話も例外ではないんじゃないだろうか。まるで回線業者の案内を見ると、10Gプランにすれば快適なインターネット速度が出せるように見えるが、そんなことはない。金が余っていて、なんとなく10Gでみたいな人はともかく、本気で回線速度を上げて10GbEの世界に踏み込みたい場合は回線を10Gにするだけではダメだ。単に余計に金がかかるだけだ。

10GbEに踏み込むには、基本始端から終端まで10GbE対応する必要がある。つまり、

ワイヤレスの場合
    * Wi-Fi 6E以上、せめてWi-Fi 6の無線LAN対応
    * 2Gbps以上のトラフィックに対応できるコンピューティングリソース
    * 無線LANルータWAN端子の10GbE対応
    * 有線ケーブルの10GbE対応

有線の場合
    * 10GbE対応のネットワークアダプタ
    * 2Gbps以上のトラフィックに対応できるコンピューティングリソース
    * ルータWAN/LAN両端子の10GbE対応
    * 有線ケーブルの10GbE対応

が揃ってる必要がある。具体的には、Wi-Fi 経由のタブレットで動画を見る時、10GbEの恩恵を受けるなら、

* 無線LANルータのWAN端子(インターネット端子)が、10GBase-T対応のもの (伝送速度 10GBps と書いてある場合もある)
    - レンタルするONUによっては、5GBase-T、2.5GBase-T対応でも一部恩恵を受けられるかもしれない
* 無線LANルータが、IEEE 802.11ax以上対応のもの (Wi-Fi 6、Wi-Fi 6E と書いてある場合もある)
    - 2025年1月現在、IEEE 802.11ax、IEEE 802.11beが該当する
    - せめてIEEE 802.11ac (Wi-Fi 5)であれば、一部恩恵を受けられるかもしれない
* タブレットの無線LANアダプタが、IEEE 802.11ax以上対応のもの
    - せめてIEEE 802.11ac (Wi-Fi 5)であれば、一部恩恵を受けられるかもしれない
* 配線はカテゴリ6A以上のLANケーブルを使う
    - せめてカテゴリ6であれば、一部恩恵を受けられるかもしれない
    - なお、仕組み上基本カテゴリが高くなるほどケーブルは太くなるので、6Aで十分

で周りを固める必要がある。これらの条件が一部でも欠ける場合、正直1G回線でも大差はないだろう。ケーブル以外は大体それぞれここ数年で出てきたものなので、だいたい買い換える必要があるはずで、その投資額は万単位にはなるはずだ。回線料金の増加額がいくら小さく見えたところで、1G回線に比べて高くなる以上、投資額が見合ってるかはちゃんと考えたほうがいい。

ついでに、有線でPCなどに接続する場合も当然ネットワークアダプタ (NIC) が10GbE対応、具体的には10GBase-T対応してないと意味がない。また、ルータのLANポートも10GBase-T対応している必要がある。10GBase-T対応のNICは、当然PCIeスロット結構取るので、新しく買って刺すにしろPCのボードに空きスロットがそれなりにある必要がある。たまにSwitchのオンラインゲームの体験向上で10G回線勧めてる話見ることがあるが、SwitchのNICは1000Base-Tまでの対応なので、最大1GBpsまでだ。最大を常に出したいとかならともかく、基本1G回線で配線全部1000Base-T対応するぐらいでいいんじゃないかと思う。

今回僕は、

* 元々配線はカテゴリ6Aのでやってて（てかLANケーブルはカテゴリ6Aで統一してる）、
* NECの無線LANルータは前のがそろそろサポート期間終わりそうだったのと、たまにハングするのがうざくて、ついでに `Baffalo WXR-11000XE12 <https://www.buffalo.jp/product/detail/wxr-11000xe12.html>`_ に乗り換え、
* PCのNICも10GbE NIC買ってきて差し替え
* スイッチハブは1000Base-Tのもの2個使ってたが、1個だけルータからの分岐ハブを10GBase-Tのものに買い換え、もう1個はまあいいやって思ってそのまま

をやって締めて10万ぐらいはかかってる気がする。端末はWi-Fi 6対応してる奴らと、対応してない奴らが半々って感じで、買い替えするまでは恩恵受けるのは半分ぐらいかなって感じ。ま、それでも1G回線よりは快適になったのでいいかなって感じ。ただ、これから契約する人は、ここまでの手間と費用かける価値があるかはちょっと考えたほうがいいんじゃないかとは思う。

IPoEとIPv6
-------------------------------

さて、ここからは少し話が逸れるんだけど、ビッグローブ光の10GプランはIPv6オプションというものが強制させられるのでその話。これは僕は1Gプランの時から利用していたんだけど、今回ルータ買い換えるにあたって設定でちょっと手間取った部分なので。

ビッグローブ光には、IPv6オプションというのがある。従来はIPv4 PPPoEでのインターネット提供になるんだが、このオプションつけるとIPoE接続での提供になる。IPoEというのは、元々はIP over Ethernet の略で、単にイーサネット上でIP通信する、LANにおいて普通のネットワーク方式だ。じゃあ、なぜ元々それをインターネットでは使ってなかったのかという話なんだが、これはかなり日本の歴史の話になるので、今回は省略する。ひとまず押さえておいて欲しいのは、

* 現在のインターネット光回線基盤は、NTT フレッツが管理するIPv6ネットワーク網 (NGN網) を各社が共有して使っている
* 回線業者のいうIPv4 PPPoE、IPv6 IPoE接続というのは、正確にはNGN網を通してプロバイダ認証を受けつつ、インターネットとどう通信するかの方式を指す

ということだ。よくIPv6 IPoEはネイティブ方式とか言われてるのを見かけると思うが、あれはIPv6がNGN網でのネイティブの通信方式であり、さらに認証もプロバイダではなくNGN網内でやってくれるからで、つまりNGN網の仕組みで閉じているからだ。逆にIPv4 PPPoE、IPv6 PPPoEは、末端とプロバイダはPPPoE接続して、プロバイダが認証し、NGN網内やインターネット通信はIPv6でやるわけだから特殊ということであり、オーバヘッドも当然かかるし、プロバイダがボトルネックになるため色々不便になりやすいということだ。これはポッと出で出てきた話ではなく、ADSLから光への移行でNGN網構築する時に目論まれていたことがようやく実現してきたという話ではある。PPPoEでの接続は今までのマイグレーションのための一時的なもので、将来的には全てIPv6 IPoEへの移行が進んでいくと思われる。なお、IP over EthernetはもちろんIPv4 over Ethernetも含むわけだが、上の事情からIPv4 over Ethernetは単にIPv6への変換コストがかかってPPPoEと事情が変わらないため提供されていない。そういうわけで、IPoEはIPv6前提の接続方式とかいう謎の説明が巷で流布しているワケだが、あれはネイティブにNGN網と接続するにはIPv6 over Ethernetである必要があり、IPv4 over Ethernetは使う意味がないためというのが正しい。

その流れで、ビッグローブ光だけではなく、他の業者でもIPoE接続の普及を進めているわけで、おそらくその一環として新しく10Gサービス提供する上でIPoE必須にしましょうという話になったんだろう。とにかく、ビッグローブ光 10Gプランでは、IPv6 IPoE必須になっている。ただ、これで困るのが、世界的にまだIPv4通信がインターネットの半分のトラフィックで使われているという事実だ。その背景にはもちろんクライアント側の対応が追いついていないというのもあるが、IPv6非対応のサービスが結構あるという側面がある。つまり、インターネットとのやり取りをIPv6通信のみに限定してしまうと、そういうサービスへの利用を阻害してしまうことになり、それが許容されるほどの状況ではないということだ。そこで、ネット回線各業者はそれぞれIPv4 over IPv6の整備をしているのが現状になる。つまり、末端からNGN網内に入るときと、NGN網からIPv4インターネットに出る時に、いい感じにIPv4への変換をかましつつ、NGN網上ではIPv6通信することでIPoE接続を実現しようというわけだ。ややこしいのが、IPoEの導入はNGN網という統一のものがある以上足並みが揃ったんだが、IPv4 over IPv6は技術がトラフィック品質というビジネス価値に直結するということ、元々IPv4 over IPv6標準規格が色々迷走していたことも相待って、足並みが揃わなかった。その結果、プロバイダ側で多数のIPv4 over IPv6方式が開発、運用され、ルータ側がなんとかそれに全て追従するという現状がある。さらに、もちろん接続するプロバイダで方式が違うわけなので、昨今のルータにはこの方式を自動判定する機能というのがついていて、回線業者の案内もこの自動判定機能に頼っているというのが現状になる。僕はこの辺正直詳しくないので詳細は話せないのだが、ビッグローブ光ではMAP-Eという規格をベースにした、独自の実装を使っている。これは、現在最も普及しているIPv4 over IPv6方式である、v6プラスという方式との互換実装らしい。

つまり、ビッグローブ光 10Gプランを使用してまともにインターネッツするには、最低でもIPv6対応と、ビッグローブ光IPv6オプション対応が必要になり、恩恵を受けるならさらに10GbE対応が必要になるということだ。もちろんこんな背景普通の人が知る由もないので、ビッグローブ光のCSからは各案内で「お使いのルータはMAP-E対応が必要になります」と連呼されることになる。しかも恐ろしいことに、MAP-E(ビッグローブ光IPv6オプション)対応しているかはルータのマニュアル・仕様を見ても分からない場合が多く、ファームウェアバージョンで左右されたりもするということになる。おそらくビッグローブ光CSも、ルータ側のCSも全容を把握してないだろうから、問い合わせても正確なところは分からないだろう [#map-e-support]_。そういう背景があるので、ビッグローブ光 10Gプランは割と上級者向けかもしれない。多分トラブルなくいくことを祈るか、ビッグローブ光が提供するレンタルルータを一時的に借りてそれで凌ぎつつ、自分のルータ買って接続できるか試してみるぐらいのリスクコントロールはしておいたほうがいいかもしれない。

WXR-11000XE12の設定
----------------------------

最後に備忘録的に、今回やったルータの設定も載せておく。上の背景の通りで、これ通りにやって1年後もちゃんと動くかは分からんが...。

まず、インターネット接続する前にルータのセキュリティ周りの設定だけ見ておく。 `マニュアル <https://manual.buffalo.jp/buf-doc/35022678-02.pdf>`_ を見つつ、やっていく。WXR-11000XE12は、初期LAN側アドレスとして192.168.11.1を使う。セットアップツールダウンロードして立ち上げると、このアドレスをブラウザで立ち上げるんだが、ま最初から Wi-Fi か有線で LAN に繋いで、 ``http://192.168.11.1`` 叩けばいい。初期パスワードは、同梱された紙に書いてあるはずなので見ておくのがいいだろう。で、今回は

管理パスワード変更
    当然のこととして

WPA2 SSID無効化
    端末が対応してればWPA3だけで十分なので。電波干渉も減るし。なお、古い端末は古い認証にしか対応してないことあるので、その点は気をつけたほうがいい

各 SSID パスワード変更
    これも当然。もし、WPA2、WPA残すなら、そのSSIDとWPA3でパスワード分けておいたほうが無難

EasyMesh無効化
    使わないので

WPS無効化
    使わないので。WPSはセキュリティ的に脆弱なので。まあでも使うやつは使うので、その点は気をつけて

AOSSボタン無効化
    使わないので。本体持ち上げようとした時、たまに間違えて押しちゃう

共有フォルダー機能無効化
    やるとしてもLANにはやらせんだろ... ということで無効化

をやった。やるべきかは分からんけど、手癖みたいなもので。で、その後ルータ再起動しておく。

後は、回線工事終わったらONUの認証ランプがついてるかは確認しておく。これがついてない場合、回線工事がトラブってるか、回線がトラブってるか、ONUがトラブってる。その場合は頑張ってくれ。で、ONUとルータをLANケーブルで繋ぐ。ルータのLANケーブルはWAN端子に繋ぐ。これでちゃんとルータが認識されれば、ONU側のついてなかったランプ(僕の場合はUNIランプ)がつくはず。これで、ルータのインターネットランプもついて、インターネット接続が普通はできるようになる。

インターネット接続されたら、ファームウェアを最新に更新しておくと良い。インターネット接続できなかったら、Internet > IPv6 の設定を多分頑張って見直すことになる。今回僕はそんなことなかったけど、ルータ再起動、設定初期化、LANポートのケーブル一旦全部抜いてやってみるとかはやった方がいいかも。後、ステータス > ログってところを確認するのがいい。上で言ったように、基本的に昨今のルータはIPv4 over IPv6方式を自動判定する機能がついていて、今回のルータも自動判定がデフォルトになっている。で、その場合、ログには

    Starting Internet@Start targeting address type is IPv6.

みたいなメッセージが出てるはず。もしちゃんと機能していれば、その後のどこかで

    Confirmed MAP-E(V6OPTION).

みたいなメッセージが出てるはず。逆に失敗していたり、検出が誤動作してる場合はその旨のメッセージが出てるはずなので、そこから頑張って原因究明していくしかなさそう。その場合は辛いことになるだろうけど頑張ってくれって感じ。

で、それが上手くいけばそこで終わりかというと、微妙な話が待っている。というのは、このルータのIPv4 over IPv6モードはデフォルトで、LAN内はIPv6に対応しないようになっている。つまり

    端末 <-IPv4-> ルータ <-IPv6 (IPv4 over IPv6)-> ONU <-IPv6 (IPv4 over IPv6)-> NGN <-IPv4-> インターネット

みたいな経路の通信しか許されない。そのため、アクセス先のサービスがIPv6対応していても、全部IPv4になってしまう。これを確認するには、

    curl -v https://flets-east.jp

とかやってみるのがいい。フレッツのサイトはIPv6にしか対応してないので、アクセスできないはず。これでもまあIPoEの恩恵は受けられるが、IPv6で直通したほうが当然速い。そこで、LAN内でもIPv6を使うようにする。Internet > IPv6の設定で、「インターネット@スタートを使う」というオプションが選ばれてると思うが、その項目に付随して「IPv6ブリッジを許可する」というチェックがあるはず。これをオンにして再起動しておくと、IPv6対応してるサービスについては

    端末 <-IPv6-> ルータ <-IPv6-> ONU <-IPv6-> NGN <-IPv6-> インターネット

となり、IPv6での直通になる。フレッツのサイトでも繋がるようになるはず。もちろん、端末がIPv6対応してればだけど。

まとめ
--------------

というわけで、10G回線普及の背景と、それにまつわるいろんな話、10G回線導入にあたって気をつけることなどをつらつら書いた。色々ハマりポイントあったが、これで次に同じことあっても、もうちょっとうまく対処できるといいなあ。後、10G導入する時は、ちゃんと投資に見合ってるか考えたほうがいいぞ、現場からは以上です。というわけで、今回はこれで。

.. [#biglobe-and-ntt-flets] https://join.biglobe.ne.jp/ftth/hikari/faq/faq-bh001.html?cl=faq-bh001 ら辺からの推測
.. [#map-e-support] これは実は実体験した。実は、元々NEC WG2600HP3というルータを使ってて、回線変更時もこれでいけるかなと思ってそのままにしてたんだが、結果的にうまくいかなかった。これをビッグローブ光に問い合わせたところ、NTT、NECへとたらい回しにされた挙句結局解決しなかった。原因は今も不明のままで、元々IPv6オプションで接続できてたので、新しいONUとの伝送速度面での食い合わせが悪かったんじゃないかとは思っている。ただ、このルータはビッグローブ光のFAQにも、NECのFAQにもIPv6オプションに対応していると案内されていたのに、双方のCSからMAP-E対応うまくできていないんじゃないかと言われた。ま、新しいルータ買っといてよかったって感じ。
